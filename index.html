<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Framed Memories</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Spectral:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/bordered-gallery.css">
</head>
<body>
  <div
    class="countdown-overlay start-prompt"
    id="startOverlay"
    role="button"
    tabindex="0"
    aria-label="Start the countdown"
  >
    <div class="countdown-overlay-content">
      <span class="countdown-overlay-line countdown-overlay-line--top">get ready</span>
      <button class="countdown-overlay-button" id="startCountdownButton" type="button">click here</button>
      <span class="countdown-overlay-line countdown-overlay-line--bottom">to party</span>
    </div>
  </div>
  <div class="page-border">
    <div class="border-cell top-left-wide" data-reveal-index="1"><img src="assets/images/AUG4710_bw.jpg" alt="Couple laughing together"></div>
    <div class="border-cell top-center" data-reveal-index="2"><img src="assets/images/AUG4726_bw.jpg" alt="Holding hands"></div>
    <div class="border-cell top-right" data-reveal-index="3"><img src="assets/images/AUG4759_bw.jpg" alt="Sharing a quiet moment together"></div>

    <div class="border-cell middle-left-tall" data-reveal-index="4"><img src="assets/images/AUG4849_bw.jpg" alt="Walking through the forest"></div>
    <div class="card-shell" id="cardShell">
      <div class="countdown-wrapper" aria-live="polite">
        <p class="eyebrow">Celebration Countdown</p>
        <div class="countdown-number" id="countdownNumber" role="status" aria-label="Countdown starting">10</div>
        <p class="countdown-note">Counting down the final moments until the big day.</p>
      </div>
    </div>
    <div class="border-cell right-tall" data-reveal-index="5"><img src="assets/images/AUG5177_bw.jpg" alt="Laughing in the field"></div>

    <div class="border-cell bottom-left" data-reveal-index="6"><img src="assets/images/AUG5106_bw.jpg" alt="Smiling under the trees"></div>
    <div class="border-cell bottom-wide" data-reveal-index="7"><img src="assets/images/AUG5127_bw.jpg" alt="Holding close"></div>
    <div class="border-cell bottom-right" data-reveal-index="8"><img src="assets/images/AUG5201_bw.jpg" alt="Strolling along the shoreline"></div>
  </div>
  <div class="mobile-experience" id="mobileExperience" aria-live="polite" aria-label="Slideshow of our memories">
    <div class="mobile-stage" id="mobileStage"></div>
  </div>
  <script>
    const AudioContextConstructor = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;

    const getAudioContext = () => {
      if (!AudioContextConstructor) {
        return null;
      }

      if (!audioCtx) {
        try {
          audioCtx = new AudioContextConstructor();
        } catch (error) {
          audioCtx = null;
          return null;
        }
      }

      return audioCtx;
    };

    const playBeat = () => {
      const context = getAudioContext();
      if (!context) return;
      if (context.state === 'suspended') {
        context.resume().catch(() => {});
      }

      const osc = context.createOscillator();
      const gain = context.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(82, context.currentTime);
      osc.connect(gain);
      gain.connect(context.destination);

      const now = context.currentTime;
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(1.3, now + 0.012);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.34);
      osc.start(now);
      osc.stop(now + 0.34);
    };

    const playBoom = () => {
      const context = getAudioContext();
      if (!context) return;

      if (context.state === 'suspended') {
        context.resume().catch(() => {});
      }

      const now = context.currentTime;
      const duration = 0.82;

      const toneOscillator = context.createOscillator();
      const toneGain = context.createGain();
      toneOscillator.type = 'sine';
      toneOscillator.frequency.setValueAtTime(180, now);
      toneOscillator.frequency.exponentialRampToValueAtTime(52, now + duration);
      toneGain.gain.setValueAtTime(0.0001, now);
      toneGain.gain.exponentialRampToValueAtTime(1.1, now + 0.02);
      toneGain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
      toneOscillator.connect(toneGain);
      toneGain.connect(context.destination);

      toneOscillator.start(now);
      toneOscillator.stop(now + duration);

      const noiseBuffer = context.createBuffer(1, Math.ceil(context.sampleRate * duration), context.sampleRate);
      const noiseChannelData = noiseBuffer.getChannelData(0);
      for (let i = 0; i < noiseChannelData.length; i += 1) {
        const decay = 1 - i / noiseChannelData.length;
        noiseChannelData[i] = (Math.random() * 2 - 1) * decay * decay;
      }

      const noiseSource = context.createBufferSource();
      noiseSource.buffer = noiseBuffer;
      const noiseGain = context.createGain();
      noiseGain.gain.setValueAtTime(0.5, now);
      noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
      noiseSource.connect(noiseGain);
      noiseGain.connect(context.destination);

      noiseSource.start(now);
      noiseSource.stop(now + duration);
    };

    const launchConfetti = () => {
      if (prefersReducedMotion) {
        return;
      }

      if (!document.body) {
        return;
      }

      const confettiContainer = document.createElement('div');
      confettiContainer.className = 'confetti-container';
      const colors = ['#ffe3a2', '#f6b8d1', '#95d5b2', '#7fd1ff', '#ffffff'];
      const pieceCount = 80;

      for (let index = 0; index < pieceCount; index += 1) {
        const piece = document.createElement('span');
        piece.className = 'confetti-piece';
        piece.style.setProperty('--confetti-left', `${Math.random() * 100}%`);
        piece.style.setProperty('--confetti-delay', `${Math.random() * 0.45}s`);
        piece.style.setProperty('--confetti-duration', `${2.6 + Math.random()}s`);
        piece.style.setProperty('--confetti-drift', `${Math.random() * 120 - 60}px`);
        piece.style.backgroundColor = colors[index % colors.length];
        confettiContainer.appendChild(piece);
      }

      document.body.appendChild(confettiContainer);
      window.setTimeout(() => {
        confettiContainer.remove();
      }, 4200);
    };

    const borderCells = Array.from(document.querySelectorAll('.border-cell')).sort((first, second) => {
      const firstIndex = Number(first.dataset.revealIndex) || 0;
      const secondIndex = Number(second.dataset.revealIndex) || 0;
      return firstIndex - secondIndex;
    });

    const prefersReducedMotionQuery = typeof window.matchMedia === 'function'
      ? window.matchMedia('(prefers-reduced-motion: reduce)')
      : null;
    const prefersReducedMotion = prefersReducedMotionQuery?.matches ?? false;

    if (prefersReducedMotion) {
      borderCells.forEach((cell) => {
        cell.classList.add('is-visible');
      });
    }

    const mobileExperience = document.getElementById('mobileExperience');
    const mobileStage = document.getElementById('mobileStage');
    const mobileBreakpointQuery = typeof window.matchMedia === 'function'
      ? window.matchMedia('(max-width: 640px), (max-height: 520px)')
      : null;
    let isMobileExperienceActive = mobileBreakpointQuery?.matches ?? false;

    const updateMobileExperiencePreference = (event) => {
      if (typeof event?.matches === 'boolean') {
        isMobileExperienceActive = event.matches;
      } else if (mobileBreakpointQuery) {
        isMobileExperienceActive = mobileBreakpointQuery.matches;
      }
    };

    if (mobileBreakpointQuery) {
      if (typeof mobileBreakpointQuery.addEventListener === 'function') {
        mobileBreakpointQuery.addEventListener('change', updateMobileExperiencePreference);
      } else if (typeof mobileBreakpointQuery.addListener === 'function') {
        mobileBreakpointQuery.addListener(updateMobileExperiencePreference);
      }
    }

    const mobilePhotoDetails = borderCells.map((cell) => {
      const cellImage = cell.querySelector('img');
      return {
        src: cellImage?.getAttribute('src') ?? '',
        alt: cellImage?.getAttribute('alt') ?? '',
      };
    });

    const cardShell = document.getElementById('cardShell');
    const initialCountdownWrapper = cardShell?.querySelector('.countdown-wrapper');
    const countdownNumber = document.getElementById('countdownNumber');
    const countdownNote = initialCountdownWrapper?.querySelector('.countdown-note');
    const countdownStart = borderCells.length > 0 ? borderCells.length : 10;
    let currentValue = countdownStart;
    let revealedCells = 0;
    let countdownIntervalId = null;
    let hasStarted = false;

    const startOverlay = document.getElementById('startOverlay');
    const startOverlayContent = startOverlay?.querySelector('.countdown-overlay-content') ?? null;
    const startButton = document.getElementById('startCountdownButton');

    const revealNextBorderCell = () => {
      if (prefersReducedMotion || isMobileExperienceActive) {
        return;
      }

      const nextCell = borderCells[revealedCells];
      if (nextCell) {
        nextCell.classList.add('is-visible');
        revealedCells += 1;
      }
    };

    const buildSaveTheDateDetails = () => {
      const wrapper = document.createElement('div');
      wrapper.className = 'countdown-wrapper has-details';

      const eyebrow = document.createElement('p');
      eyebrow.className = 'eyebrow';
      eyebrow.textContent = 'Save the Date';

      const title = document.createElement('h1');
      title.className = 'save-date-title';
      const firstName = document.createElement('span');
      firstName.className = 'save-date-name';
      firstName.textContent = 'Lorraine';

      const ampersand = document.createElement('span');
      ampersand.className = 'save-date-amp';
      ampersand.textContent = '&';

      const secondName = document.createElement('span');
      secondName.className = 'save-date-name';
      secondName.textContent = 'Christopher';

      title.append(firstName, ampersand, secondName);

      const dateLine = document.createElement('p');
      dateLine.className = 'save-date-date';
      const dateMain = document.createElement('span');
      dateMain.className = 'save-date-date-main';
      dateMain.textContent = 'September 12, 2026';

      const dateLocation = document.createElement('span');
      dateLocation.className = 'save-date-date-location';
      dateLocation.textContent = 'Portola, California';

      dateLine.append(dateMain, dateLocation);

      const note = document.createElement('p');
      note.className = 'countdown-note save-date-note';
      note.textContent = 'Formal invite to follow';

      wrapper.appendChild(eyebrow);
      wrapper.appendChild(title);
      wrapper.appendChild(dateLine);
      wrapper.appendChild(note);

      return { wrapper, title };
    };

    const revealSaveTheDateDetails = ({ title }, { withCelebrateEffects = false } = {}) => {
      if (withCelebrateEffects && !prefersReducedMotion) {
        window.requestAnimationFrame(() => {
          title.classList.add('save-date-title--spiral');
        });

        window.setTimeout(() => {
          playBoom();
          launchConfetti();
        }, 520);
      }
    };

    const showSaveTheDateDetails = ({
      targetContainer = cardShell,
      withCelebrateEffects = false,
    } = {}) => {
      if (!targetContainer) return;

      const elements = buildSaveTheDateDetails();
      targetContainer.innerHTML = '';
      targetContainer.appendChild(elements.wrapper);
      revealSaveTheDateDetails(elements, { withCelebrateEffects });
    };

    const buildCelebrationVideo = () => {
      const wrapper = document.createElement('div');
      wrapper.className = 'countdown-wrapper has-video';

      const videoHashtag = document.createElement('p');
      videoHashtag.className = 'video-hashtag';
      videoHashtag.textContent = '#BECOMINGCUMMINGS';

      const videoFrame = document.createElement('div');
      videoFrame.className = 'countdown-video-frame';

      const celebrationVideo = document.createElement('video');
      celebrationVideo.className = 'countdown-video';
      celebrationVideo.src = 'assets/video.mp4';
      celebrationVideo.autoplay = true;
      celebrationVideo.muted = false;
      celebrationVideo.controls = true;
      celebrationVideo.setAttribute('playsinline', '');

      videoFrame.appendChild(celebrationVideo);

      wrapper.appendChild(videoHashtag);
      wrapper.appendChild(videoFrame);

      return { wrapper, celebrationVideo };
    };

    const safelyPlayVideo = (videoElement) => {
      if (!videoElement) {
        return;
      }

      const attemptVideoPlayback = () => {
        const playPromise = videoElement.play();
        if (playPromise && typeof playPromise.catch === 'function') {
          playPromise.catch(() => {});
        }
      };

      if (videoElement.readyState >= 2) {
        attemptVideoPlayback();
      } else {
        videoElement.addEventListener('canplay', attemptVideoPlayback, { once: true });
      }
    };

    const showCelebrationVideo = ({
      targetContainer = cardShell,
      onVideoEnded,
      onVideoError,
      withCelebrateEffectsOnComplete = true,
    } = {}) => {
      if (!targetContainer) return;

      const { wrapper, celebrationVideo } = buildCelebrationVideo();
      targetContainer.innerHTML = '';
      targetContainer.appendChild(wrapper);

      const resolvedOnEnded = typeof onVideoEnded === 'function'
        ? onVideoEnded
        : () => {
            if (withCelebrateEffectsOnComplete) {
              showSaveTheDateDetails({ targetContainer, withCelebrateEffects: true });
            } else {
              showSaveTheDateDetails({ targetContainer });
            }
          };

      const resolvedOnError = typeof onVideoError === 'function'
        ? onVideoError
        : () => {
            showSaveTheDateDetails({ targetContainer });
          };

      celebrationVideo.addEventListener('ended', () => {
        window.setTimeout(resolvedOnEnded, 600);
      }, { once: true });

      celebrationVideo.addEventListener('error', () => {
        resolvedOnError();
      }, { once: true });

      safelyPlayVideo(celebrationVideo);
    };

    const createMobileFrame = (additionalClassName = '') => {
      const frame = document.createElement('div');
      frame.className = `mobile-frame${additionalClassName ? ` ${additionalClassName}` : ''}`;
      return frame;
    };

    const swapMobileFrame = (newFrame) => {
      if (!mobileStage) {
        return;
      }

      const transitionDelay = prefersReducedMotion ? 0 : 520;
      const existingFrame = mobileStage.firstElementChild;

      const placeNewFrame = () => {
        mobileStage.replaceChildren(newFrame);
        if (prefersReducedMotion) {
          newFrame.classList.add('is-visible');
        } else {
          window.requestAnimationFrame(() => {
            newFrame.classList.add('is-visible');
          });
        }
      };

      if (existingFrame && !prefersReducedMotion) {
        existingFrame.classList.remove('is-visible');
        window.setTimeout(placeNewFrame, transitionDelay);
      } else {
        placeNewFrame();
      }
    };

    const showMobileSaveTheDate = ({ withCelebrateEffects = true } = {}) => {
      if (!mobileStage) {
        return;
      }

      const elements = buildSaveTheDateDetails();
      const frame = createMobileFrame('mobile-frame--card');
      frame.appendChild(elements.wrapper);

      swapMobileFrame(frame);

      const reveal = () => {
        revealSaveTheDateDetails(elements, { withCelebrateEffects });
      };

      if (prefersReducedMotion) {
        reveal();
      } else {
        window.setTimeout(reveal, 80);
      }
    };

    const showMobileVideo = () => {
      if (!mobileStage) {
        return;
      }

      const { wrapper, celebrationVideo } = buildCelebrationVideo();
      const frame = createMobileFrame('mobile-frame--video');
      frame.appendChild(wrapper);

      swapMobileFrame(frame);

      celebrationVideo.addEventListener('ended', () => {
        window.setTimeout(() => {
          showMobileSaveTheDate({ withCelebrateEffects: true });
        }, 600);
      }, { once: true });

      celebrationVideo.addEventListener('error', () => {
        showMobileSaveTheDate({ withCelebrateEffects: false });
      }, { once: true });

      safelyPlayVideo(celebrationVideo);
    };

    const showMobilePhotoAtIndex = (index) => {
      if (!mobileStage) {
        return;
      }

      const photoDetails = mobilePhotoDetails[index];
      if (!photoDetails || !photoDetails.src) {
        showMobileVideo();
        return;
      }

      const frame = createMobileFrame('mobile-frame--photo');
      const image = document.createElement('img');
      image.src = photoDetails.src;
      image.alt = photoDetails.alt || '';
      frame.appendChild(image);

      playBeat();
      swapMobileFrame(frame);

      const displayDuration = prefersReducedMotion ? 1600 : 2000;
      window.setTimeout(() => {
        showMobilePhotoAtIndex(index + 1);
      }, displayDuration);
    };

    const startMobileSequence = () => {
      if (!mobileStage) {
        showCelebrationVideo({ targetContainer: cardShell });
        return;
      }

      if (mobilePhotoDetails.length === 0) {
        showMobileVideo();
        return;
      }

      showMobilePhotoAtIndex(0);
    };
    const handleCountdownTick = () => {
      if (!countdownNumber) {
        return;
      }

      currentValue -= 1;
      countdownNumber.classList.add('is-transitioning');
      playBeat();

      if (currentValue <= 0) {
        countdownNumber.textContent = '0';
        countdownNumber.setAttribute('aria-label', 'Countdown finished');
        window.clearInterval(countdownIntervalId);
        revealNextBorderCell();
        if (countdownNote) {
          countdownNote.textContent = "It's time to celebrate!";
        }
        window.setTimeout(() => {
          showCelebrationVideo();
        }, 400);
      } else {
        countdownNumber.textContent = String(currentValue);
        countdownNumber.setAttribute('aria-label', `Countdown at ${currentValue}`);
        revealNextBorderCell();
      }

      window.setTimeout(() => {
        countdownNumber.classList.remove('is-transitioning');
      }, 360);
    };

    const startCountdownFlow = () => {
      if (isMobileExperienceActive) {
        startMobileSequence();
        return;
      }

      if (!countdownNumber || !initialCountdownWrapper) {
        showCelebrationVideo();
        return;
      }

      countdownNumber.textContent = String(currentValue);
      countdownNumber.setAttribute('aria-label', `Countdown at ${currentValue}`);
      revealNextBorderCell();
      playBeat();
      countdownIntervalId = window.setInterval(handleCountdownTick, 1100);
    };

    const startExperience = () => {
      if (hasStarted) {
        return;
      }

      hasStarted = true;

      if (startOverlayContent) {
        startOverlayContent.classList.add('is-clearing');
      }

      if (startOverlay) {
        startOverlay.removeEventListener('click', startExperience);
        startOverlay.removeEventListener('keydown', handleOverlayKeyDown);
        startOverlay.classList.add('is-counting');
        window.setTimeout(() => {
          startOverlay.classList.add('hidden');
          startOverlay.setAttribute('aria-hidden', 'true');
          startOverlay.setAttribute('tabindex', '-1');
        }, 420);
      }

      if (startButton) {
        startButton.removeEventListener('click', startExperience);
        startButton.disabled = true;
        startButton.setAttribute('tabindex', '-1');
      }

      const context = getAudioContext();
      if (context && context.state === 'suspended') {
        context.resume().catch(() => {});
      }

      if (isMobileExperienceActive) {
        startMobileSequence();
      } else {
        startCountdownFlow();
      }
    };

    const handleOverlayKeyDown = (event) => {
      if (!event) {
        return;
      }

      const triggerKeys = ['Enter', ' ', 'Spacebar'];
      if (triggerKeys.includes(event.key)) {
        event.preventDefault();
        startExperience();
      }
    };

    if (startButton) {
      startButton.addEventListener('click', startExperience);
    }

    if (startOverlay) {
      startOverlay.addEventListener('click', startExperience);
      startOverlay.addEventListener('keydown', handleOverlayKeyDown);
    }

    if (!startOverlay || !startButton) {
      startExperience();
    }
  </script>
</body>
</html>
