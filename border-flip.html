<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Framed Memories Flip</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Spectral:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/bordered-gallery-flip.css">
</head>
<body>
  <div
    class="countdown-overlay start-prompt"
    id="startOverlay"
    role="button"
    tabindex="0"
    aria-label="Start the countdown"
  >
    <div class="countdown-overlay-content">
      <span class="countdown-overlay-line countdown-overlay-line--top">get ready</span>
      <button class="countdown-overlay-button" id="startCountdownButton" type="button">click here</button>
      <span class="countdown-overlay-line countdown-overlay-line--bottom">to party</span>
    </div>
  </div>
  <div class="page-border">
    <div class="border-cell top-left"><img src="assets/images/AUG4710_bw.jpg" alt="Couple laughing together"></div>
    <div class="border-cell top-center"><img src="assets/images/AUG4726_bw.jpg" alt="Holding hands"></div>
    <div class="border-cell top-right"><img src="assets/images/AUG4738_bw.jpg" alt="Looking at each other"></div>

    <div class="border-cell middle-left"><img src="assets/images/AUG4849_bw.jpg" alt="Walking through the forest"></div>

    <main class="content-card">
      <div class="card-shell">
        <div class="countdown-wrapper" aria-live="polite">
          <p class="countdown-prompt countdown-prompt--top">get ready</p>
          <div class="countdown-number" id="countdownNumber" role="status" aria-label="Countdown at 10">10</div>
          <p class="countdown-prompt countdown-prompt--bottom">to party</p>
        </div>
      </div>
    </main>

    <div class="border-cell middle-right"><img src="assets/images/AUG4869_bw.jpg" alt="Dancing together"></div>

    <div class="border-cell bottom-left"><img src="assets/images/AUG5106_bw.jpg" alt="Smiling under the trees"></div>
    <div class="border-cell bottom-center"><img src="assets/images/AUG5127_bw.jpg" alt="Holding close"></div>
    <div class="border-cell bottom-right"><img src="assets/images/AUG5139_bw.jpg" alt="Walking by the lake"></div>
  </div>

  <script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = AudioContext ? new AudioContext() : null;
    const playBeat = () => {
      if (!audioCtx) return;
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().catch(() => {});
      }

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(82, audioCtx.currentTime);
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(1.3, now + 0.012);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.34);
      osc.start(now);
      osc.stop(now + 0.34);
    };

    const borderCells = Array.from(document.querySelectorAll('.border-cell'));
    const countdownWrapper = document.querySelector('.countdown-wrapper');
    const cardShell = countdownWrapper ? countdownWrapper.closest('.card-shell') : null;
    const countdownNumber = document.getElementById('countdownNumber');
    const countdownStart = 10;
    let currentValue = countdownStart;
    const startOverlay = document.getElementById('startOverlay');
    const startOverlayContent = startOverlay
      ? startOverlay.querySelector('.countdown-overlay-content')
      : null;
    const startButton = document.getElementById('startCountdownButton');
    let countdownInterval = null;
    let revealIndex = 0;
    let hasUserInteracted = false;
    let hasClearedStartPrompt = false;

    const totalCountdownSteps = countdownStart + 1;
    const totalBorderCells = borderCells.length;
    const baseRevealCount = totalCountdownSteps > 0 ? Math.floor(totalBorderCells / totalCountdownSteps) : 0;
    const extraRevealSteps = totalCountdownSteps > 0 ? totalBorderCells % totalCountdownSteps : 0;
    const revealSchedule = Array.from({ length: totalCountdownSteps }, () => baseRevealCount);
    for (let step = 0; step < extraRevealSteps; step += 1) {
      const index = revealSchedule.length - 1 - step;
      if (index >= 0) {
        revealSchedule[index] += 1;
      }
    }

    const prefersReducedMotionQuery =
      typeof window.matchMedia === 'function'
        ? window.matchMedia('(prefers-reduced-motion: reduce)')
        : null;
    let shouldReduceMotion = prefersReducedMotionQuery?.matches ?? false;

    const updateMotionPreference = (event) => {
      shouldReduceMotion = event.matches;
    };

    if (prefersReducedMotionQuery) {
      if (typeof prefersReducedMotionQuery.addEventListener === 'function') {
        prefersReducedMotionQuery.addEventListener('change', updateMotionPreference);
      } else if (typeof prefersReducedMotionQuery.addListener === 'function') {
        prefersReducedMotionQuery.addListener(updateMotionPreference);
      }
    }

    const defaultSpinDurationMs = 2800;
    const readSpinDuration = () => {
      try {
        const rootStyle = window.getComputedStyle(document.documentElement);
        const rawValue = rootStyle?.getPropertyValue('--card-spin-duration');
        const parsedSeconds = rawValue ? parseFloat(rawValue) : Number.NaN;
        return Number.isFinite(parsedSeconds) ? parsedSeconds * 1000 : defaultSpinDurationMs;
      } catch (error) {
        return defaultSpinDurationMs;
      }
    };

    let slowSpinDurationMs = readSpinDuration();
    let slowSpinTimeoutId = null;
    let hasRevealedDetails = false;

    const revealNextCells = (count = 1) => {
      for (let i = 0; i < count; i += 1) {
        if (revealIndex >= totalBorderCells) {
          return;
        }

        const cell = borderCells[revealIndex];
        if (cell) {
          const progress = totalBorderCells > 1 ? revealIndex / (totalBorderCells - 1) : 1;
          const baseDuration = 1.8;
          const minDuration = 1.05;
          const duration = Math.max(minDuration, baseDuration - (baseDuration - minDuration) * progress);
          cell.style.setProperty('--border-cell-duration', `${duration.toFixed(2)}s`);
          requestAnimationFrame(() => {
            cell.classList.add('is-visible');
          });
        }

        revealIndex += 1;
      }
    };

    let revealStep = 0;
    const applyRevealSchedule = () => {
      const count = revealSchedule[revealStep] ?? 0;
      if (count > 0) {
        revealNextCells(count);
      }
      revealStep += 1;
    };

    const updateCountdownDisplay = (value) => {
      if (!countdownNumber) return;

      countdownNumber.textContent = String(value);
      countdownNumber.setAttribute(
        'aria-label',
        value <= 0 ? 'Countdown finished' : `Countdown at ${value}`
      );
    };

    const finishCountdown = () => {
      window.clearInterval(countdownInterval);
      countdownInterval = null;
      window.setTimeout(() => {
        startOverlay?.classList.add('hidden');
        showCelebrationVideo();
      }, 500);
    };

    if (countdownNumber) {
      updateCountdownDisplay(currentValue);
    }

    const showSaveTheDateDetails = () => {
      if (!countdownWrapper || hasRevealedDetails) {
        return;
      }

      hasRevealedDetails = true;
      if (slowSpinTimeoutId !== null) {
        window.clearTimeout(slowSpinTimeoutId);
        slowSpinTimeoutId = null;
      }

      countdownWrapper.classList.remove('has-video');
      countdownWrapper.classList.add('has-details');
      countdownWrapper.innerHTML = '';

      const eyebrow = document.createElement('p');
      eyebrow.className = 'eyebrow';
      eyebrow.textContent = 'Save the Date';

      const title = document.createElement('h1');
      title.className = 'save-date-title';
      title.innerHTML = '<span class="save-date-name">Lorraine</span>' +
        '<span class="save-date-amp">&amp;</span>' +
        '<span class="save-date-name">Christopher</span>';

      const dateLine = document.createElement('p');
      dateLine.className = 'save-date-date';
      dateLine.innerHTML = '<span class="save-date-date-main">September 12, 2026</span>' +
        '<span class="save-date-date-location">Portola, California</span>';

      const note = document.createElement('p');
      note.className = 'countdown-note save-date-note';
      note.textContent = 'Formal invite to follow';

      countdownWrapper.appendChild(eyebrow);
      countdownWrapper.appendChild(title);
      countdownWrapper.appendChild(dateLine);
      countdownWrapper.appendChild(note);

      if (cardShell) {
        cardShell.classList.remove('is-video');
        cardShell.classList.add('is-details');
        cardShell.classList.remove('is-revealing');
      }
    };

    const startSlowSpinReveal = () => {
      if (hasRevealedDetails) {
        return;
      }

      if (!cardShell || shouldReduceMotion) {
        showSaveTheDateDetails();
        return;
      }

      slowSpinDurationMs = readSpinDuration();
      cardShell.classList.add('is-revealing');

      if (slowSpinTimeoutId !== null) {
        window.clearTimeout(slowSpinTimeoutId);
      }

      slowSpinTimeoutId = window.setTimeout(() => {
        slowSpinTimeoutId = null;
        showSaveTheDateDetails();
      }, Math.max(0, Math.floor(slowSpinDurationMs * 0.5)));

      const handleAnimationEnd = () => {
        cardShell?.classList.remove('is-revealing');
        if (!hasRevealedDetails) {
          showSaveTheDateDetails();
        }
      };

      cardShell.addEventListener('animationend', handleAnimationEnd, { once: true });
    };

    const showCelebrationVideo = () => {
      if (!countdownWrapper) {
        return;
      }

      countdownWrapper.classList.add('has-video');
      countdownWrapper.classList.remove('has-details');
      countdownWrapper.innerHTML = '';

      const videoFrame = document.createElement('div');
      videoFrame.className = 'countdown-video-frame';

      const videoHashtag = document.createElement('p');
      videoHashtag.className = 'video-hashtag';
      videoHashtag.textContent = '#BECOMINGCUMMINGS';

      const celebrationVideo = document.createElement('video');
      celebrationVideo.className = 'countdown-video';
      celebrationVideo.src = 'assets/video.mp4';
      celebrationVideo.autoplay = true;
      celebrationVideo.loop = false;
      celebrationVideo.muted = !hasUserInteracted;
      celebrationVideo.setAttribute('playsinline', '');

      if (!celebrationVideo.muted) {
        celebrationVideo.removeAttribute('muted');
        celebrationVideo.volume = 1;
      } else {
        celebrationVideo.setAttribute('muted', '');
      }

      const handleVideoComplete = () => {
        startSlowSpinReveal();
      };

      celebrationVideo.addEventListener('ended', handleVideoComplete, { once: true });
      celebrationVideo.addEventListener(
        'error',
        () => {
          handleVideoComplete();
        },
        { once: true }
      );

      videoFrame.appendChild(celebrationVideo);
      countdownWrapper.appendChild(videoHashtag);
      countdownWrapper.appendChild(videoFrame);

      const playPromise = celebrationVideo.play();
      if (playPromise && typeof playPromise.catch === 'function') {
        playPromise.catch(() => {
          if (!celebrationVideo.muted) {
            celebrationVideo.muted = true;
            celebrationVideo.play().catch(() => {});
          }
        });
      }

      if (cardShell) {
        cardShell.classList.remove('is-details');
        cardShell.classList.add('is-video');
      }
    };

    const clearStartPrompt = () => {
      if (hasClearedStartPrompt || !startOverlayContent) {
        return;
      }

      hasClearedStartPrompt = true;
      startOverlayContent.classList.add('is-clearing');
      window.setTimeout(() => {
        startOverlayContent.innerHTML = '';
      }, 320);
    };

    const startCountdown = () => {
      if (!countdownNumber || countdownInterval !== null) {
        return;
      }

      clearStartPrompt();
      startOverlay?.classList.remove('start-prompt');
      startOverlay?.classList.add('is-counting');
      startOverlay?.setAttribute('aria-hidden', 'true');
      startOverlay?.setAttribute('tabindex', '-1');

      updateCountdownDisplay(currentValue);
      playBeat();
      applyRevealSchedule();

      countdownInterval = window.setInterval(() => {
        currentValue -= 1;
        if (!countdownNumber) {
          return;
        }

        countdownNumber.classList.add('is-transitioning');

        const value = Math.max(0, currentValue);
        updateCountdownDisplay(value);
        playBeat();
        applyRevealSchedule();

        window.setTimeout(() => {
          countdownNumber.classList.remove('is-transitioning');
        }, 220);

        if (value <= 0) {
          finishCountdown();
        }
      }, 1000);
    };

    const markUserInteraction = () => {
      hasUserInteracted = true;
      audioCtx?.resume().catch(() => {});
    };

    const handleOverlayKeydown = (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        markUserInteraction();
        startCountdown();
      }
    };

    if (startOverlay) {
      startOverlay.addEventListener('click', () => {
        markUserInteraction();
        startCountdown();
      });
      startOverlay.addEventListener('keydown', handleOverlayKeydown);
    } else if (countdownNumber) {
      markUserInteraction();
      updateCountdownDisplay(currentValue);
      playBeat();
      applyRevealSchedule();

      countdownInterval = window.setInterval(() => {
        currentValue -= 1;
        if (!countdownNumber) {
          return;
        }

        countdownNumber.classList.add('is-transitioning');
        const value = Math.max(0, currentValue);
        updateCountdownDisplay(value);
        playBeat();
        applyRevealSchedule();

        window.setTimeout(() => {
          countdownNumber.classList.remove('is-transitioning');
        }, 220);

        if (value <= 0) {
          finishCountdown();
        }
      }, 1000);
    }

    if (startButton) {
      startButton.addEventListener('click', (event) => {
        event.stopPropagation();
        markUserInteraction();
        startCountdown();
      });
    }
  </script>
</body>
</html>
